{% extends "front-end/base.html" %}

{% block main_block %}
<h1>Processing Your Payment</h1>
<p>Please complete the payment on your phone for Checkout Request ID: {{ checkout_request_id }}</p>
<div class="loader"></div>
    <p class="message" id="status-message">Checking payment status...</p>

</div>
<div class="text-center">
    <a href="{% url 'tvet-ai' %}" class="btn btn-secondary mt-3">Proceed To generate</a>
</div>
    <script>
        function pollTransactionStatus() {
            fetch('/check-transaction-status/')
            .then(response => response.json())
            .then(data => {
                console.log("Response:", data);
                const statusMessage = document.getElementById('status-message');
                statusMessage.textContent = data.message;

                if (data.status === 'success' || data.status === 'failed') {
                    console.log("Redirecting to:", data.redirect_url);
                    // Stop polling and redirect
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000); // Brief delay to show message
                } else {
                    // Continue polling if pending
                    setTimeout(pollTransactionStatus, 5000); // Poll every 5 seconds
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('status-message').textContent = 'Error checking payment status. Please try again.';
            });
        }

        // Start polling immediately
        pollTransactionStatus();
    </script>

{% endblock main_block %}